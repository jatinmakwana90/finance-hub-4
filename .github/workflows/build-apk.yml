name: Build Android APK - My Finance Hub

on:
  push:
    branches: [main, master]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - uses: gradle/actions/setup-gradle@v3
      - uses: android-actions/setup-android@v3

      - name: Accept licenses
        run: yes | sdkmanager --licenses || true

      - name: Install dependencies
        run: npm install

      - name: Build web app
        run: npm run build

      - name: Add Android platform
        run: npx cap add android

      - name: Sync Capacitor
        run: npx cap sync android

      - name: Fix Gradle wrapper permissions
        run: chmod +x android/gradlew

      - name: Update Gradle wrapper to 8.7
        run: cd android && ./gradlew wrapper --gradle-version=8.7 --distribution-type=bin

      - name: Show files before patching
        run: |
          echo "=== build.gradle ===" && cat android/app/build.gradle
          echo "=== AndroidManifest.xml ===" && cat android/app/src/main/AndroidManifest.xml

      - name: Patch build.gradle and AndroidManifest (safe Python)
        run: |
          python3 << 'PYEOF'
          import re

          # ── Patch build.gradle ──────────────────────────────────────
          with open("android/app/build.gradle", "r") as f:
              gradle = f.read()

          # Only replace the number after minSdkVersion / targetSdkVersion
          gradle = re.sub(r'(minSdkVersion\s+)\d+',    r'\g<1>24',  gradle)
          gradle = re.sub(r'(targetSdkVersion\s+)\d+', r'\g<1>34',  gradle)

          with open("android/app/build.gradle", "w") as f:
              f.write(gradle)

          print("build.gradle patched OK")
          # Print relevant lines for verification
          for line in gradle.splitlines():
              if any(k in line for k in ["minSdk","targetSdk","compileSdk","versionCode","versionName"]):
                  print(" ", line.strip())

          # ── Patch AndroidManifest.xml ───────────────────────────────
          with open("android/app/src/main/AndroidManifest.xml", "r") as f:
              manifest = f.read()

          # Remove cleartext traffic flag safely
          manifest = manifest.replace('android:usesCleartextTraffic="true"', '')

          # Add missing permissions before </manifest>
          perms_to_add = [
              '<uses-permission android:name="android.permission.POST_NOTIFICATIONS"/>',
              '<uses-permission android:name="android.permission.RECEIVE_BOOT_COMPLETED"/>',
              '<uses-permission android:name="android.permission.VIBRATE"/>',
          ]
          for perm in perms_to_add:
              perm_name = re.search(r'android:name="([^"]+)"', perm).group(1)
              if perm_name not in manifest:
                  manifest = manifest.replace('</manifest>', f'    {perm}\n</manifest>')
                  print(f"Added: {perm_name}")
              else:
                  print(f"Already present: {perm_name}")

          with open("android/app/src/main/AndroidManifest.xml", "w") as f:
              f.write(manifest)

          print("AndroidManifest.xml patched OK")
          PYEOF

      - name: Show patched files
        run: |
          echo "=== Patched build.gradle ===" && cat android/app/build.gradle
          echo "=== Patched Manifest ===" && cat android/app/src/main/AndroidManifest.xml

      - name: Build debug APK
        run: cd android && ./gradlew assembleDebug --no-daemon --stacktrace -Dorg.gradle.jvmargs="-Xmx3g"

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: MyFinanceHub-APK-v4
          path: android/app/build/outputs/apk/debug/app-debug.apk
          retention-days: 30
